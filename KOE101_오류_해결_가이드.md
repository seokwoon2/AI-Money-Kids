# 🔧 KOE101 오류 해결 가이드

## 오류 메시지
```
앱 관리자 설정 오류 (KOE101)
서비스 설정에 오류가 있어, 이용할 수 없습니다.
```

## 원인

KOE101 오류는 Streamlit Cloud에서 앱 초기화 중 발생하는 오류입니다. 주요 원인:

1. **최상단에서 Streamlit Secrets 접근**
   - `app.py` 최상단에서 `st.secrets`에 접근하면 Streamlit이 완전히 초기화되기 전에 오류 발생 가능

2. **OAuth 서비스 초기화 오류**
   - `OAuthService()` 초기화 시 Secrets 접근 실패

3. **Import 오류**
   - 필수 모듈이 없거나 import 경로 오류

## 해결 방법

### ✅ 수정 완료된 사항

1. **OAuth 서비스 지연 초기화**
   - `app.py` 최상단에서 즉시 초기화하지 않음
   - 필요할 때만 초기화하도록 변경

2. **안전한 Secrets 접근**
   - `OAuthService.__init__()`에서 예외 처리 강화
   - Secrets 접근 실패 시 환경 변수로 대체

### 📋 확인 사항

#### 1. Streamlit Cloud Secrets 설정 확인

Streamlit Cloud 대시보드 → 앱 설정 → Secrets 탭에서:

```toml
[secrets]
GOOGLE_API_KEY = "AIzaSy..."
KAKAO_REST_API_KEY = "여기에_카카오_키"
KAKAO_REDIRECT_URI = "https://your-app-url.streamlit.app/"
```

**중요:**
- `[secrets]` 섹션 필수
- 모든 키는 따옴표로 감싸기
- 키 이름 정확히 입력 (대소문자 구분)

#### 2. requirements.txt 확인

프로젝트 루트에 `requirements.txt` 파일이 있고 다음 패키지가 포함되어 있는지 확인:

```
streamlit>=1.28.0
google-generativeai>=0.3.0
python-dotenv>=1.0.0
pandas>=2.0.0
plotly>=5.17.0
bcrypt>=4.0.0
groq>=0.4.0
requests>=2.31.0
```

#### 3. app.py 파일 확인

- `app.py` 파일이 프로젝트 루트에 있는지 확인
- Streamlit Cloud 설정에서 "Main file path"가 `app.py`로 설정되어 있는지 확인

#### 4. 로그 확인

Streamlit Cloud 대시보드에서:
1. 앱 설정 → **Logs** 탭 클릭
2. 오류 메시지 확인
3. 구체적인 오류 내용 확인

## 단계별 해결 방법

### 1단계: 코드 푸시 확인

```powershell
git add .
git commit -m "Fix KOE101 error - lazy initialization"
git push
```

### 2단계: Streamlit Cloud에서 재배포

1. Streamlit Cloud 대시보드 접속
2. 앱 선택
3. Settings → **Reboot app** 클릭
4. 또는 코드가 자동으로 재배포됨

### 3단계: Secrets 재설정

1. Settings → **Secrets** 탭
2. 기존 내용 삭제
3. 올바른 형식으로 다시 입력:

```toml
[secrets]
GOOGLE_API_KEY = "AIzaSy여기에_실제_키"
KAKAO_REST_API_KEY = "여기에_카카오_키"
KAKAO_REDIRECT_URI = "https://your-app-url.streamlit.app/"
```

4. **Save** 클릭

### 4단계: 앱 재시작

1. Settings → **Reboot app** 클릭
2. 몇 분 대기
3. 앱 URL로 접속 테스트

## 추가 문제 해결

### Secrets 형식 오류

**올바른 형식:**
```toml
[secrets]
GOOGLE_API_KEY = "값"
```

**잘못된 형식:**
```toml
# 섹션 없음
GOOGLE_API_KEY = "값"

# 따옴표 없음
GOOGLE_API_KEY = 값

# 소문자
google_api_key = "값"
```

### Import 오류

만약 로그에서 import 오류가 보이면:

1. `requirements.txt`에 누락된 패키지 추가
2. 코드 푸시
3. 앱 재시작

### 데이터베이스 경로 오류

`config.py`에서 데이터베이스 경로 확인:
```python
DATABASE_PATH = "data/money_kids.db"
```

프로젝트에 `data` 폴더가 있는지 확인하고, 없으면 생성:

```powershell
mkdir data
```

## 예방 방법

1. **최상단에서 Secrets 접근 금지**
   - `app.py` 최상단에서 `st.secrets` 직접 접근하지 않기
   - 함수 내부에서만 접근

2. **예외 처리 강화**
   - 모든 Secrets 접근에 try-except 사용
   - 기본값 제공

3. **지연 초기화 사용**
   - 필요할 때만 서비스 초기화
   - 세션 상태에 저장하여 재사용

## 완료 체크리스트

- [ ] 코드 수정 완료
- [ ] Git 푸시 완료
- [ ] Streamlit Cloud 재배포 완료
- [ ] Secrets 형식 확인 완료
- [ ] 앱 재시작 완료
- [ ] 로그 확인 완료
- [ ] 앱 접속 테스트 완료

## 도움이 필요하면

1. **로그 확인**: Settings → Logs 탭
2. **Streamlit 커뮤니티**: https://discuss.streamlit.io/
3. **GitHub Issues**: 프로젝트 저장소의 Issues 탭

---

**참고:** 수정된 코드는 이미 적용되어 있습니다. Git에 푸시하고 Streamlit Cloud에서 재배포하면 해결됩니다.
